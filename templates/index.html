<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload Video Blob Example</title>
</head>
<body>
  <h2>ðŸŽ¥ Ghi hÃ¬nh & Gá»­i video lÃªn backend</h2>
  <video id="preview" autoplay muted></video>
  <br/>
  <button id="startBtn">Báº¯t Ä‘áº§u ghi</button>
  <button id="stopBtn" disabled>Káº¿t thÃºc & Upload</button>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const video = document.getElementById("preview");

    let mediaRecorder;
    let recordedChunks = [];

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      video.srcObject = stream;

      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = async () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const formData = new FormData();
        formData.append("video", blob, "recorded_video.webm");

        try {
          const res = await fetch("http://localhost:5000/upload", {
            method: "POST",
            body: formData
          });

          const data = await res.json();
          alert("Server response: " + JSON.stringify(data));
        } catch (err) {
          console.error("Upload error:", err);
          alert("Upload failed!");
        }
      };

      mediaRecorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
    }

    startBtn.addEventListener("click", startRecording);

    stopBtn.addEventListener("click", () => {
      mediaRecorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;

      // Stop all video/audio tracks
      video.srcObject.getTracks().forEach(track => track.stop());
    });
  </script>
</body>
</html>
